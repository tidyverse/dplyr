<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Per-operation grouping with .by/by — dplyr_by • dplyr</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Per-operation grouping with .by/by — dplyr_by"><meta name="description" content="There are two ways to group in dplyr:
Persistent grouping with group_by()
Per-operation grouping with .by/by


This help page is dedicated to explaining where and why you might want to use the latter.
Depending on the dplyr verb, the per-operation grouping argument may be named .by or by.
The Supported verbs section below outlines this on a case-by-case basis.
The remainder of this page will refer to .by for simplicity.
Grouping radically affects the computation of the dplyr verb you use it with, and one of the goals of .by is to allow you to place that grouping specification alongside the code that actually uses it.
As an added benefit, with .by you no longer need to remember to ungroup() after summarise(), and summarise() won't ever message you about how it's handling the groups!
This idea comes from data.table, which allows you to specify by alongside modifications in j, like: dt[, .(x = mean(x)), by = g].
Supported verbs


mutate(.by = )
summarise(.by = )
reframe(.by = )
filter(.by = )
slice(.by = )
slice_head(by = ) and slice_tail(by = )
slice_min(by = ) and slice_max(by = )
slice_sample(by = )


Note that some dplyr verbs use by while others use .by.
This is a purely technical difference.



Differences between .by and group_by()

.bygroup_by()
Grouping only affects a single verbGrouping is persistent across multiple verbs
Selects variables with tidy-selectComputes expressions with data-masking
Summaries use existing order of group keysSummaries sort group keys in ascending order







Using .by


Let's take a look at the two grouping approaches using this expenses data set, which tracks costs accumulated across various ids and regions:
expenses &amp;lt;- tibble(
  id = c(1, 2, 1, 3, 1, 2, 3),
  region = c(&quot;A&quot;, &quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;),
  cost = c(25, 20, 19, 12, 9, 6, 6)
)
expenses
#&amp;gt; # A tibble: 7 x 3
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         25
#&amp;gt; 2     2 A         20
#&amp;gt; 3     1 A         19
#&amp;gt; 4     3 B         12
#&amp;gt; 5     1 B          9
#&amp;gt; 6     2 A          6
#&amp;gt; 7     3 A          6

Imagine that you wanted to compute the average cost per region.
You'd probably write something like this:
expenses %&amp;gt;%
  group_by(region) %&amp;gt;%
  summarise(cost = mean(cost))
#&amp;gt; # A tibble: 2 x 2
#&amp;gt;   region  cost
#&amp;gt;   &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1 A       15.2
#&amp;gt; 2 B       10.5

Instead, you can now specify the grouping inline within the verb:
expenses %&amp;gt;%
  summarise(cost = mean(cost), .by = region)
#&amp;gt; # A tibble: 2 x 2
#&amp;gt;   region  cost
#&amp;gt;   &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1 A       15.2
#&amp;gt; 2 B       10.5

.by applies to a single operation, meaning that since expenses was an ungrouped data frame, the result after applying .by will also always be an ungrouped data frame, regardless of the number of grouping columns.
expenses %&amp;gt;%
  summarise(cost = mean(cost), .by = c(id, region))
#&amp;gt; # A tibble: 5 x 3
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         22
#&amp;gt; 2     2 A         13
#&amp;gt; 3     3 B         12
#&amp;gt; 4     1 B          9
#&amp;gt; 5     3 A          6

Compare that with group_by() %&amp;gt;% summarise(), where summarise() generally peels off 1 layer of grouping by default, typically with a message that it is doing so:
expenses %&amp;gt;%
  group_by(id, region) %&amp;gt;%
  summarise(cost = mean(cost))
#&amp;gt; `summarise()` has grouped output by 'id'. You can override using the `.groups`
#&amp;gt; argument.
#&amp;gt; # A tibble: 5 x 3
#&amp;gt; # Groups:   id [3]
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         22
#&amp;gt; 2     1 B          9
#&amp;gt; 3     2 A         13
#&amp;gt; 4     3 A          6
#&amp;gt; 5     3 B         12

Because .by grouping applies to a single operation, you don't need to worry about ungrouping, and it never needs to emit a message to remind you what it is doing with the groups.
Note that with .by we specified multiple columns to group by using the tidy-select syntax c(id, region).
If you have a character vector of column names you'd like to group by, you can do so with .by = all_of(my_cols).
It will group by the columns in the order they were provided.
To prevent surprising results, you can't use .by on an existing grouped data frame:
expenses %&amp;gt;%
  group_by(id) %&amp;gt;%
  summarise(cost = mean(cost), .by = c(id, region))
#&amp;gt; Error in `summarise()`:
#&amp;gt; ! Can't supply `.by` when `.data` is a grouped data frame.

So far we've focused on the usage of .by with summarise(), but .by works with a number of other dplyr verbs.
For example, you could append the mean cost per region onto the original data frame as a new column rather than computing a summary:
expenses %&amp;gt;%
  mutate(cost_by_region = mean(cost), .by = region)
#&amp;gt; # A tibble: 7 x 4
#&amp;gt;      id region  cost cost_by_region
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;          &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         25           15.2
#&amp;gt; 2     2 A         20           15.2
#&amp;gt; 3     1 A         19           15.2
#&amp;gt; 4     3 B         12           10.5
#&amp;gt; 5     1 B          9           10.5
#&amp;gt; 6     2 A          6           15.2
#&amp;gt; 7     3 A          6           15.2

Or you could slice out the maximum cost per combination of id and region:
# Note that the argument is named `by` in `slice_max()`
expenses %&amp;gt;%
  slice_max(cost, n = 1, by = c(id, region))
#&amp;gt; # A tibble: 5 x 3
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         25
#&amp;gt; 2     2 A         20
#&amp;gt; 3     3 B         12
#&amp;gt; 4     1 B          9
#&amp;gt; 5     3 A          6




Result ordering


When used with .by, summarise(), reframe(), and slice() all maintain the ordering of the existing data.
This is different from group_by(), which has always sorted the group keys in ascending order.
df &amp;lt;- tibble(
  month = c(&quot;jan&quot;, &quot;jan&quot;, &quot;feb&quot;, &quot;feb&quot;, &quot;mar&quot;),
  temp = c(20, 25, 18, 20, 40)
)

# Uses ordering by &quot;first appearance&quot; in the original data
df %&amp;gt;%
  summarise(average_temp = mean(temp), .by = month)
#&amp;gt; # A tibble: 3 x 2
#&amp;gt;   month average_temp
#&amp;gt;   &amp;lt;chr&amp;gt;        &amp;lt;dbl&amp;gt;
#&amp;gt; 1 jan           22.5
#&amp;gt; 2 feb           19
#&amp;gt; 3 mar           40

# Sorts in ascending order
df %&amp;gt;%
  group_by(month) %&amp;gt;%
  summarise(average_temp = mean(temp))
#&amp;gt; # A tibble: 3 x 2
#&amp;gt;   month average_temp
#&amp;gt;   &amp;lt;chr&amp;gt;        &amp;lt;dbl&amp;gt;
#&amp;gt; 1 feb           19
#&amp;gt; 2 jan           22.5
#&amp;gt; 3 mar           40

If you need sorted group keys, we recommend that you explicitly use arrange() either before or after the call to summarise(), reframe(), or slice().
This also gives you full access to all of arrange()'s features, such as desc() and the .locale argument.



Verbs without .by support


If a dplyr verb doesn't support .by, then that typically means that the verb isn't inherently affected by grouping.
For example, pull() and rename() don't support .by, because specifying columns to group by would not affect their implementations.
That said, there are a few exceptions to this where sometimes a dplyr verb doesn't support .by, but does have special support for grouped data frames created by group_by().
This is typically because the verbs are required to retain the grouping columns, for example:
select() always retains grouping columns, with a message if any aren't specified in the select() call.
distinct() and count() place unspecified grouping columns at the front of the data frame before computing their results.
arrange() has a .by_group argument to optionally order by grouping columns first.


If group_by() didn't exist, then these verbs would not have special support for grouped data frames.

"><meta property="og:description" content="There are two ways to group in dplyr:
Persistent grouping with group_by()
Per-operation grouping with .by/by


This help page is dedicated to explaining where and why you might want to use the latter.
Depending on the dplyr verb, the per-operation grouping argument may be named .by or by.
The Supported verbs section below outlines this on a case-by-case basis.
The remainder of this page will refer to .by for simplicity.
Grouping radically affects the computation of the dplyr verb you use it with, and one of the goals of .by is to allow you to place that grouping specification alongside the code that actually uses it.
As an added benefit, with .by you no longer need to remember to ungroup() after summarise(), and summarise() won't ever message you about how it's handling the groups!
This idea comes from data.table, which allows you to specify by alongside modifications in j, like: dt[, .(x = mean(x)), by = g].
Supported verbs


mutate(.by = )
summarise(.by = )
reframe(.by = )
filter(.by = )
slice(.by = )
slice_head(by = ) and slice_tail(by = )
slice_min(by = ) and slice_max(by = )
slice_sample(by = )


Note that some dplyr verbs use by while others use .by.
This is a purely technical difference.



Differences between .by and group_by()

.bygroup_by()
Grouping only affects a single verbGrouping is persistent across multiple verbs
Selects variables with tidy-selectComputes expressions with data-masking
Summaries use existing order of group keysSummaries sort group keys in ascending order







Using .by


Let's take a look at the two grouping approaches using this expenses data set, which tracks costs accumulated across various ids and regions:
expenses &amp;lt;- tibble(
  id = c(1, 2, 1, 3, 1, 2, 3),
  region = c(&quot;A&quot;, &quot;A&quot;, &quot;A&quot;, &quot;B&quot;, &quot;B&quot;, &quot;A&quot;, &quot;A&quot;),
  cost = c(25, 20, 19, 12, 9, 6, 6)
)
expenses
#&amp;gt; # A tibble: 7 x 3
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         25
#&amp;gt; 2     2 A         20
#&amp;gt; 3     1 A         19
#&amp;gt; 4     3 B         12
#&amp;gt; 5     1 B          9
#&amp;gt; 6     2 A          6
#&amp;gt; 7     3 A          6

Imagine that you wanted to compute the average cost per region.
You'd probably write something like this:
expenses %&amp;gt;%
  group_by(region) %&amp;gt;%
  summarise(cost = mean(cost))
#&amp;gt; # A tibble: 2 x 2
#&amp;gt;   region  cost
#&amp;gt;   &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1 A       15.2
#&amp;gt; 2 B       10.5

Instead, you can now specify the grouping inline within the verb:
expenses %&amp;gt;%
  summarise(cost = mean(cost), .by = region)
#&amp;gt; # A tibble: 2 x 2
#&amp;gt;   region  cost
#&amp;gt;   &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1 A       15.2
#&amp;gt; 2 B       10.5

.by applies to a single operation, meaning that since expenses was an ungrouped data frame, the result after applying .by will also always be an ungrouped data frame, regardless of the number of grouping columns.
expenses %&amp;gt;%
  summarise(cost = mean(cost), .by = c(id, region))
#&amp;gt; # A tibble: 5 x 3
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         22
#&amp;gt; 2     2 A         13
#&amp;gt; 3     3 B         12
#&amp;gt; 4     1 B          9
#&amp;gt; 5     3 A          6

Compare that with group_by() %&amp;gt;% summarise(), where summarise() generally peels off 1 layer of grouping by default, typically with a message that it is doing so:
expenses %&amp;gt;%
  group_by(id, region) %&amp;gt;%
  summarise(cost = mean(cost))
#&amp;gt; `summarise()` has grouped output by 'id'. You can override using the `.groups`
#&amp;gt; argument.
#&amp;gt; # A tibble: 5 x 3
#&amp;gt; # Groups:   id [3]
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         22
#&amp;gt; 2     1 B          9
#&amp;gt; 3     2 A         13
#&amp;gt; 4     3 A          6
#&amp;gt; 5     3 B         12

Because .by grouping applies to a single operation, you don't need to worry about ungrouping, and it never needs to emit a message to remind you what it is doing with the groups.
Note that with .by we specified multiple columns to group by using the tidy-select syntax c(id, region).
If you have a character vector of column names you'd like to group by, you can do so with .by = all_of(my_cols).
It will group by the columns in the order they were provided.
To prevent surprising results, you can't use .by on an existing grouped data frame:
expenses %&amp;gt;%
  group_by(id) %&amp;gt;%
  summarise(cost = mean(cost), .by = c(id, region))
#&amp;gt; Error in `summarise()`:
#&amp;gt; ! Can't supply `.by` when `.data` is a grouped data frame.

So far we've focused on the usage of .by with summarise(), but .by works with a number of other dplyr verbs.
For example, you could append the mean cost per region onto the original data frame as a new column rather than computing a summary:
expenses %&amp;gt;%
  mutate(cost_by_region = mean(cost), .by = region)
#&amp;gt; # A tibble: 7 x 4
#&amp;gt;      id region  cost cost_by_region
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;          &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         25           15.2
#&amp;gt; 2     2 A         20           15.2
#&amp;gt; 3     1 A         19           15.2
#&amp;gt; 4     3 B         12           10.5
#&amp;gt; 5     1 B          9           10.5
#&amp;gt; 6     2 A          6           15.2
#&amp;gt; 7     3 A          6           15.2

Or you could slice out the maximum cost per combination of id and region:
# Note that the argument is named `by` in `slice_max()`
expenses %&amp;gt;%
  slice_max(cost, n = 1, by = c(id, region))
#&amp;gt; # A tibble: 5 x 3
#&amp;gt;      id region  cost
#&amp;gt;   &amp;lt;dbl&amp;gt; &amp;lt;chr&amp;gt;  &amp;lt;dbl&amp;gt;
#&amp;gt; 1     1 A         25
#&amp;gt; 2     2 A         20
#&amp;gt; 3     3 B         12
#&amp;gt; 4     1 B          9
#&amp;gt; 5     3 A          6




Result ordering


When used with .by, summarise(), reframe(), and slice() all maintain the ordering of the existing data.
This is different from group_by(), which has always sorted the group keys in ascending order.
df &amp;lt;- tibble(
  month = c(&quot;jan&quot;, &quot;jan&quot;, &quot;feb&quot;, &quot;feb&quot;, &quot;mar&quot;),
  temp = c(20, 25, 18, 20, 40)
)

# Uses ordering by &quot;first appearance&quot; in the original data
df %&amp;gt;%
  summarise(average_temp = mean(temp), .by = month)
#&amp;gt; # A tibble: 3 x 2
#&amp;gt;   month average_temp
#&amp;gt;   &amp;lt;chr&amp;gt;        &amp;lt;dbl&amp;gt;
#&amp;gt; 1 jan           22.5
#&amp;gt; 2 feb           19
#&amp;gt; 3 mar           40

# Sorts in ascending order
df %&amp;gt;%
  group_by(month) %&amp;gt;%
  summarise(average_temp = mean(temp))
#&amp;gt; # A tibble: 3 x 2
#&amp;gt;   month average_temp
#&amp;gt;   &amp;lt;chr&amp;gt;        &amp;lt;dbl&amp;gt;
#&amp;gt; 1 feb           19
#&amp;gt; 2 jan           22.5
#&amp;gt; 3 mar           40

If you need sorted group keys, we recommend that you explicitly use arrange() either before or after the call to summarise(), reframe(), or slice().
This also gives you full access to all of arrange()'s features, such as desc() and the .locale argument.



Verbs without .by support


If a dplyr verb doesn't support .by, then that typically means that the verb isn't inherently affected by grouping.
For example, pull() and rename() don't support .by, because specifying columns to group by would not affect their implementations.
That said, there are a few exceptions to this where sometimes a dplyr verb doesn't support .by, but does have special support for grouped data frames created by group_by().
This is typically because the verbs are required to retain the grouping columns, for example:
select() always retains grouping columns, with a message if any aren't specified in the select() call.
distinct() and count() place unspecified grouping columns at the front of the data frame before computing their results.
arrange() has a .by_group argument to optionally order by grouping columns first.


If group_by() didn't exist, then these verbs would not have special support for grouped data frames.

"><meta property="og:image" content="https://dplyr.tidyverse.org/logo.png"><meta name="robots" content="noindex"><script defer data-domain="dplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dplyr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.4.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/dplyr.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/grouping.html">Grouped data</a></li>
    <li><a class="dropdown-item" href="../articles/two-table.html">Two-table verbs</a></li>
    <li><a class="dropdown-item" href="../articles/base.html">dplyr &lt;-&gt; base R</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Automation</h6></li>
    <li><a class="dropdown-item" href="../articles/colwise.html">Column-wise operations</a></li>
    <li><a class="dropdown-item" href="../articles/rowwise.html">Row-wise operations</a></li>
    <li><a class="dropdown-item" href="../articles/programming.html">Programming with dplyr</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/tags/dplyr-1-1-0/">Version 1.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/06/dplyr-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/07/dplyr-0-8-3/">Version 0.8.3</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/06/dplyr-0-8-2/">Version 0.8.2</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/05/dplyr-0-8-1/">Version 0.8.1</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/02/dplyr-0-8-0/">Version 0.8.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/06/dplyr-0.7.5/">Version 0.7.5</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/dplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Per-operation grouping with <code>.by</code>/<code>by</code></h1>
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dplyr/blob/main/R/by.R" class="external-link"><code>R/by.R</code></a></small>
      <div class="d-none name"><code>dplyr_by.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>There are two ways to group in dplyr:</p><ul><li><p>Persistent grouping with <code><a href="group_by.html">group_by()</a></code></p></li>
<li><p>Per-operation grouping with <code>.by</code>/<code>by</code></p></li>
</ul><p>This help page is dedicated to explaining where and why you might want to use the latter.</p>
<p>Depending on the dplyr verb, the per-operation grouping argument may be named <code>.by</code> or <code>by</code>.
The <em>Supported verbs</em> section below outlines this on a case-by-case basis.
The remainder of this page will refer to <code>.by</code> for simplicity.</p>
<p>Grouping radically affects the computation of the dplyr verb you use it with, and one of the goals of <code>.by</code> is to allow you to place that grouping specification alongside the code that actually uses it.
As an added benefit, with <code>.by</code> you no longer need to remember to <code><a href="group_by.html">ungroup()</a></code> after <code><a href="summarise.html">summarise()</a></code>, and <code><a href="summarise.html">summarise()</a></code> won't ever message you about how it's handling the groups!</p>
<p>This idea comes from <a href="https://CRAN.R-project.org/package=data.table" class="external-link">data.table</a>, which allows you to specify <code>by</code> alongside modifications in <code>j</code>, like: <code>dt[, .(x = mean(x)), by = g]</code>.</p><div class="section">
<h3 id="supported-verbs">Supported verbs<a class="anchor" aria-label="anchor" href="#supported-verbs"></a></h3>

<ul><li><p><code><a href="mutate.html">mutate(.by = )</a></code></p></li>
<li><p><code><a href="summarise.html">summarise(.by = )</a></code></p></li>
<li><p><code><a href="reframe.html">reframe(.by = )</a></code></p></li>
<li><p><code><a href="filter.html">filter(.by = )</a></code></p></li>
<li><p><code><a href="slice.html">slice(.by = )</a></code></p></li>
<li><p><code><a href="slice.html">slice_head(by = )</a></code> and <code><a href="slice.html">slice_tail(by = )</a></code></p></li>
<li><p><code><a href="slice.html">slice_min(by = )</a></code> and <code><a href="slice.html">slice_max(by = )</a></code></p></li>
<li><p><code><a href="slice.html">slice_sample(by = )</a></code></p></li>
</ul><p>Note that some dplyr verbs use <code>by</code> while others use <code>.by</code>.
This is a purely technical difference.</p>
</div>

<div class="section">
<h3 id="differences-between-by-and-group-by-">Differences between <code>.by</code> and <code><a href="group_by.html">group_by()</a></code><a class="anchor" aria-label="anchor" href="#differences-between-by-and-group-by-"></a></h3>
<table class="table table"><tr><td><code>.by</code></td><td><code><a href="group_by.html">group_by()</a></code></td></tr><tr><td>Grouping only affects a single verb</td><td>Grouping is persistent across multiple verbs</td></tr><tr><td>Selects variables with <a href="dplyr_tidy_select.html">tidy-select</a></td><td>Computes expressions with <a href="https://rlang.r-lib.org/reference/args_data_masking.html" class="external-link">data-masking</a></td></tr><tr><td>Summaries use existing order of group keys</td><td>Summaries sort group keys in ascending order</td></tr></table></div>

<div class="section">
<h3 id="using-by">Using <code>.by</code><a class="anchor" aria-label="anchor" href="#using-by"></a></h3>


<p>Let's take a look at the two grouping approaches using this <code>expenses</code> data set, which tracks costs accumulated across various <code>id</code>s and <code>region</code>s:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"A"</span>, <span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"B"</span>, <span class="st">"A"</span>, <span class="st">"A"</span><span class="op">)</span>,</span>
<span>  cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">20</span>, <span class="fl">19</span>, <span class="fl">12</span>, <span class="fl">9</span>, <span class="fl">6</span>, <span class="fl">6</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">expenses</span></span>
<span><span class="co">#&gt; # A tibble: 7 x 3</span></span>
<span><span class="co">#&gt;      id region  cost</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 A         25</span></span>
<span><span class="co">#&gt; 2     2 A         20</span></span>
<span><span class="co">#&gt; 3     1 A         19</span></span>
<span><span class="co">#&gt; 4     3 B         12</span></span>
<span><span class="co">#&gt; 5     1 B          9</span></span>
<span><span class="co">#&gt; 6     2 A          6</span></span>
<span><span class="co">#&gt; 7     3 A          6</span></span></code></pre><p></p></div>
<p>Imagine that you wanted to compute the average cost per region.
You'd probably write something like this:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 x 2</span></span>
<span><span class="co">#&gt;   region  cost</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 A       15.2</span></span>
<span><span class="co">#&gt; 2 B       10.5</span></span></code></pre><p></p></div>
<p>Instead, you can now specify the grouping <em>inline</em> within the verb:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span>, .by <span class="op">=</span> <span class="va">region</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 x 2</span></span>
<span><span class="co">#&gt;   region  cost</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 A       15.2</span></span>
<span><span class="co">#&gt; 2 B       10.5</span></span></code></pre><p></p></div>
<p><code>.by</code> applies to a single operation, meaning that since <code>expenses</code> was an ungrouped data frame, the result after applying <code>.by</code> will also always be an ungrouped data frame, regardless of the number of grouping columns.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 5 x 3</span></span>
<span><span class="co">#&gt;      id region  cost</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 A         22</span></span>
<span><span class="co">#&gt; 2     2 A         13</span></span>
<span><span class="co">#&gt; 3     3 B         12</span></span>
<span><span class="co">#&gt; 4     1 B          9</span></span>
<span><span class="co">#&gt; 5     3 A          6</span></span></code></pre><p></p></div>
<p>Compare that with <code>group_by() %&gt;% summarise()</code>, where <code><a href="summarise.html">summarise()</a></code> generally peels off 1 layer of grouping by default, typically with a message that it is doing so:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">region</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'id'. You can override using the `.groups`</span></span>
<span><span class="co">#&gt; argument.</span></span>
<span><span class="co">#&gt; # A tibble: 5 x 3</span></span>
<span><span class="co">#&gt; # Groups:   id [3]</span></span>
<span><span class="co">#&gt;      id region  cost</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 A         22</span></span>
<span><span class="co">#&gt; 2     1 B          9</span></span>
<span><span class="co">#&gt; 3     2 A         13</span></span>
<span><span class="co">#&gt; 4     3 A          6</span></span>
<span><span class="co">#&gt; 5     3 B         12</span></span></code></pre><p></p></div>
<p>Because <code>.by</code> grouping applies to a single operation, you don't need to worry about ungrouping, and it never needs to emit a message to remind you what it is doing with the groups.</p>
<p>Note that with <code>.by</code> we specified multiple columns to group by using the <a href="dplyr_tidy_select.html">tidy-select</a> syntax <code>c(id, region)</code>.
If you have a character vector of column names you'd like to group by, you can do so with <code>.by = all_of(my_cols)</code>.
It will group by the columns in the order they were provided.</p>
<p>To prevent surprising results, you can't use <code>.by</code> on an existing grouped data frame:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `summarise()`:</span></span>
<span><span class="co">#&gt; ! Can't supply `.by` when `.data` is a grouped data frame.</span></span></code></pre><p></p></div>
<p>So far we've focused on the usage of <code>.by</code> with <code><a href="summarise.html">summarise()</a></code>, but <code>.by</code> works with a number of other dplyr verbs.
For example, you could append the mean cost per region onto the original data frame as a new column rather than computing a summary:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span>cost_by_region <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cost</span><span class="op">)</span>, .by <span class="op">=</span> <span class="va">region</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 7 x 4</span></span>
<span><span class="co">#&gt;      id region  cost cost_by_region</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;          &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 A         25           15.2</span></span>
<span><span class="co">#&gt; 2     2 A         20           15.2</span></span>
<span><span class="co">#&gt; 3     1 A         19           15.2</span></span>
<span><span class="co">#&gt; 4     3 B         12           10.5</span></span>
<span><span class="co">#&gt; 5     1 B          9           10.5</span></span>
<span><span class="co">#&gt; 6     2 A          6           15.2</span></span>
<span><span class="co">#&gt; 7     3 A          6           15.2</span></span></code></pre><p></p></div>
<p>Or you could slice out the maximum cost per combination of id and region:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># Note that the argument is named `by` in `slice_max()`</span></span>
<span><span class="va">expenses</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/slice.html">slice_max</a></span><span class="op">(</span><span class="va">cost</span>, n <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">region</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 5 x 3</span></span>
<span><span class="co">#&gt;      id region  cost</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 A         25</span></span>
<span><span class="co">#&gt; 2     2 A         20</span></span>
<span><span class="co">#&gt; 3     3 B         12</span></span>
<span><span class="co">#&gt; 4     1 B          9</span></span>
<span><span class="co">#&gt; 5     3 A          6</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="result-ordering">Result ordering<a class="anchor" aria-label="anchor" href="#result-ordering"></a></h3>


<p>When used with <code>.by</code>, <code><a href="summarise.html">summarise()</a></code>, <code><a href="reframe.html">reframe()</a></code>, and <code><a href="slice.html">slice()</a></code> all maintain the ordering of the existing data.
This is different from <code><a href="group_by.html">group_by()</a></code>, which has always sorted the group keys in ascending order.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"jan"</span>, <span class="st">"jan"</span>, <span class="st">"feb"</span>, <span class="st">"feb"</span>, <span class="st">"mar"</span><span class="op">)</span>,</span>
<span>  temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">25</span>, <span class="fl">18</span>, <span class="fl">20</span>, <span class="fl">40</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Uses ordering by "first appearance" in the original data</span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>average_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, .by <span class="op">=</span> <span class="va">month</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 x 2</span></span>
<span><span class="co">#&gt;   month average_temp</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 jan           22.5</span></span>
<span><span class="co">#&gt; 2 feb           19</span></span>
<span><span class="co">#&gt; 3 mar           40</span></span>
<span></span>
<span><span class="co"># Sorts in ascending order</span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">month</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span>average_temp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 x 2</span></span>
<span><span class="co">#&gt;   month average_temp</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 feb           19</span></span>
<span><span class="co">#&gt; 2 jan           22.5</span></span>
<span><span class="co">#&gt; 3 mar           40</span></span></code></pre><p></p></div>
<p>If you need sorted group keys, we recommend that you explicitly use <code><a href="arrange.html">arrange()</a></code> either before or after the call to <code><a href="summarise.html">summarise()</a></code>, <code><a href="reframe.html">reframe()</a></code>, or <code><a href="slice.html">slice()</a></code>.
This also gives you full access to all of <code><a href="arrange.html">arrange()</a></code>'s features, such as <code><a href="desc.html">desc()</a></code> and the <code>.locale</code> argument.</p>
</div>

<div class="section">
<h3 id="verbs-without-by-support">Verbs without <code>.by</code> support<a class="anchor" aria-label="anchor" href="#verbs-without-by-support"></a></h3>


<p>If a dplyr verb doesn't support <code>.by</code>, then that typically means that the verb isn't inherently affected by grouping.
For example, <code><a href="pull.html">pull()</a></code> and <code><a href="rename.html">rename()</a></code> don't support <code>.by</code>, because specifying columns to group by would not affect their implementations.</p>
<p>That said, there are a few exceptions to this where sometimes a dplyr verb doesn't support <code>.by</code>, but <em>does</em> have special support for grouped data frames created by <code><a href="group_by.html">group_by()</a></code>.
This is typically because the verbs are required to retain the grouping columns, for example:</p><ul><li><p><code><a href="select.html">select()</a></code> always retains grouping columns, with a message if any aren't specified in the <code><a href="select.html">select()</a></code> call.</p></li>
<li><p><code><a href="distinct.html">distinct()</a></code> and <code><a href="count.html">count()</a></code> place unspecified grouping columns at the front of the data frame before computing their results.</p></li>
<li><p><code><a href="arrange.html">arrange()</a></code> has a <code>.by_group</code> argument to optionally order by grouping columns first.</p></li>
</ul><p>If <code><a href="group_by.html">group_by()</a></code> didn't exist, then these verbs would not have special support for grouped data frames.</p>
</div>

    </div>



  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/romainfrancois" class="external-link">Romain François</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer></body></html>

