<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programming with dplyr • dplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="../tidyverse.css" rel="stylesheet">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../tidyverse-2.css" rel="stylesheet">
<!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><meta property="og:title" content="Programming with dplyr">
<meta property="og:description" content="dplyr">
<meta property="og:image" content="https://dplyr.tidyverse.org/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="navbar-brand" href="../index.html">dplyr</a>
        <div class="info">
          <span class="partof">part of the <a href="https://tidyverse.org">tidyverse</a></span>
          <span class="version version-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.8.99.9002</span>
        </div>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../articles/dplyr.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/two-table.html">Two-table verbs</a>
    </li>
    <li>
      <a href="../articles/window-functions.html">Window functions</a>
    </li>
    <li>
      <a href="http://dbplyr.tidyverse.org/articles/dbplyr.html">Databases with dbplyr</a>
    </li>
    <li>
      <a href="../articles/programming.html">Programming with dplyr</a>
    </li>
    <li>
      <a href="../articles/compatibility.html">Compatibility</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/10/dplyr-0-8-4/">Version 0.8.4</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/07/dplyr-0-8-3/">Version 0.8.3</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/06/dplyr-0-8-2/">Version 0.8.2</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/05/dplyr-0-8-1/">Version 0.8.1</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/02/dplyr-0-8-0/">Version 0.8.0</a>
    </li>
    <li>
      <a href="https://www.tidyverse.org/articles/2018/06/dplyr-0.7.5/">Version 0.7.5</a>
    </li>
    <li>
      <a href="../news/index.html">Change log</a>
    </li>
  </ul>
</li>
        <li>
  <a href="https://github.com/tidyverse/dplyr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Programming with dplyr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dplyr/blob/master/vignettes/programming.Rmd"><code>vignettes/programming.Rmd</code></a></small>
      <div class="hidden name"><code>programming.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>Most dplyr verbs use <strong>tidy evaluation</strong> in some way. Tidy evaluation is a special type of non-standard evaluation used throughout the tidyverse. There are two basic forms found in dplyr:</p>
<ul>
<li><p><code><a href="../reference/arrange.html">arrange()</a></code>, <code><a href="../reference/count.html">count()</a></code>, <code><a href="../reference/filter.html">filter()</a></code>, <code><a href="../reference/group_by.html">group_by()</a></code>, <code><a href="../reference/mutate.html">mutate()</a></code>, and <code><a href="../reference/summarise.html">summarise()</a></code> use <strong>data masking</strong> so that you can use data variables as if they were variables in the environment (i.e. you write <code>my_variable</code> not <code>df$myvariable</code>).</p></li>
<li><p><code><a href="../reference/across.html">across()</a></code>, <code><a href="../reference/relocate.html">relocate()</a></code>, <code><a href="../reference/rename.html">rename()</a></code>, <code><a href="../reference/select.html">select()</a></code>, and <code><a href="../reference/pull.html">pull()</a></code> use <strong>tidy selection</strong> so you can easily choose variables based on their position, name, or type (e.g. <code><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">starts_with("x")</a></code> or <code>is.numeric</code>).</p></li>
</ul>
<p>To determine whether a function argument uses data masking or tidy selection, look at the documentation: in the arguments list, you’ll see <code>&lt;data-masking&gt;</code> or <code>&lt;tidy-select&gt;</code>.</p>
<p>Data masking and tidy selection make interactive data exploration fast and fluid, but they add some new challenges when you attempt to use them indirectly such as in a for loop or a function. This vignette shows you how to overcome those challenges. We’ll first go over the basics of data masking and tidy selection, talk about how to use them indirectly, and then show you a number of recipes to solve common problems.</p>
<p>This vignette will give you the minimum knowledge you need to be an effective programmer with tidy evaluation. If you’d like to learn more about the underlying theory, or precisely how it’s different from non-standard evaluation, we recommend that you read the Metaprogramming chapters in <a href="https://adv-r.hadley.nz"><em>Advanced R</em></a>.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)</pre></body></html></div>
</div>
<div id="data-masking" class="section level2">
<h2 class="hasAnchor">
<a href="#data-masking" class="anchor"></a>Data masking</h2>
<p>Data masking makes data manipulation faster because it requires less typing. In most (but not all<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>) base R functions you need to refer to variables with <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>, leading to code that repeats the name of the data frame many times:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">starwars</span>[<span class="no">starwars</span>$<span class="no">homeworld</span> <span class="kw">==</span> <span class="st">"Naboo"</span> <span class="kw">&amp;</span> <span class="no">starwars</span>$<span class="no">species</span> <span class="kw">==</span> <span class="st">"Human"</span>, ,]</pre></body></html></div>
<p>The dplyr equivalent of this code is more concise because data masking allows you to need to type <code>starwars</code> once:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">starwars</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/filter.html">filter</a></span>(<span class="no">homeworld</span> <span class="kw">==</span> <span class="st">"Naboo"</span>, <span class="no">species</span> <span class="kw">==</span> <span class="st">"Human"</span>)</pre></body></html></div>
<div id="data--and-env-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#data--and-env-variables" class="anchor"></a>Data- and env-variables</h3>
<p>The key idea behind data masking is that it blurs the line between the two different meanings of the word “variable”:</p>
<ul>
<li><p><strong>env-variables</strong> are “programming” variables that live in an environment. They are usually created with <code>&lt;-</code>.</p></li>
<li><p><strong>data-variables</strong> are “statistical” variables that live in a data frame. They usually come from data files (e.g. <code>.csv</code>, <code>.xls</code>), or are created manipulating existing variables.</p></li>
</ul>
<p>To make those definitions a little more concrete, take this piece of code:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">3</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">3</span>))
<span class="no">df</span>$<span class="no">x</span>
<span class="co">#&gt; [1] 0.08075014 0.83433304 0.60076089</span></pre></body></html></div>
<p>It creates a env-variable, <code>df</code>, that contains two data-variables, <code>x</code> and <code>y</code>. Then it extracts the data-variable <code>x</code> out of the env-variable <code>df</code> using <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>.</p>
<p>I think this blurring of the meaning of “variable” is a really nice feature for interactive data analysis because it allows you to refer to data-vars as is, without any prefix. And this seems to be fairly intuitive since many newer R users will attempt to write <code>diamonds[x == 0 | y == 0, ]</code>.</p>
<p>Unfortunately, this benefit does not come for free. When you start to program with these tools, you’re going to have to grapple with the distinction. This will be hard because you’ve never had to think about it before, so it’ll take a while for your brain to learn these new concepts and categories. However, once you’ve teased apart the idea of “variable” into data-variable and env-variable, I think you’ll find it fairly straightforward to use.</p>
</div>
<div id="indirection" class="section level3">
<h3 class="hasAnchor">
<a href="#indirection" class="anchor"></a>Indirection</h3>
<p>The main challenge of programming with functions that use data masking arises when you introduce some indirection, i.e. when you want to get the data-variable from an env-variable instead of directly typing the data-variable’s name. There are two main cases:</p>
<ul>
<li>
<p>When you have the data-variable in a function argument (i.e. an env-variable that holds a promise<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>), you need to <strong>embrace</strong> the argument by surrounding it in doubled braces, like <code><a href="../reference/filter.html">filter(df, {{ var }})</a></code>.</p>
<p>The following function uses embracing to create a wrapper around <code><a href="../reference/summarise.html">summarise()</a></code> that computes the minimum and maximum values of a variable, as well as the number of observations that were summarised:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">var_summary</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">var</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="../reference/context.html">n</a></span>(), <span class="kw">min</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>({{ <span class="no">var</span> }}), <span class="kw">max</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>({{ <span class="no">var</span> }}))
}
<span class="no">mtcars</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">cyl</span>) <span class="kw">%&gt;%</span>
  <span class="fu">var_summary</span>(<span class="no">mpg</span>)</pre></body></html></div>
</li>
<li>
<p>When you have an env-variable that is a character vector, you need to index into the <code>.data</code> pronoun with <code><a href="https://rdrr.io/r/base/Extract.html">[[</a></code>, like <code><a href="../reference/summarise.html">summarise(df, mean = mean(.data[[var]]))</a></code>.</p>
<p>The following example uses <code>.data</code> to count the number of unique values in each variable of <code>mtcars</code>:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="kw">for</span> (<span class="no">var</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mtcars</span>)) {
  <span class="no">mtcars</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/count.html">count</a></span>(<span class="no">.data</span><span class="kw">[[</span><span class="no">var</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>()
}</pre></body></html></div>
<p>Note that <code>.data</code> is not a data frame; it’s a special construct, a pronoun, that allows you to access the current variables either directly, with <code>.data$x</code> or indirectly with <code>.data[[var]]</code>. Don’t expect other functions to work with it.</p>
</li>
</ul>
</div>
</div>
<div id="tidy-selection" class="section level2">
<h2 class="hasAnchor">
<a href="#tidy-selection" class="anchor"></a>Tidy selection</h2>
<p>Data masking makes it easy to compute on values within a dataset. Tidy selection is a complementary tool that makes it easy to work with the columns of a dataset.</p>
<div id="the-tidyselect-dsl" class="section level3">
<h3 class="hasAnchor">
<a href="#the-tidyselect-dsl" class="anchor"></a>The tidyselect DSL</h3>
<p>Underneath all functions that use tidy selection is the <a href="http://tidyselect.r-lib.org/">tidyselect</a> package. It provides a miniature domain specific language that makes it easy to select columns by name, position, or type. For example:</p>
<ul>
<li><p><code><a href="../reference/select.html">select(df, 1)</a></code> selects the first column; <code><a href="../reference/select.html">select(1, last_col())</a></code> selects the last column.</p></li>
<li><p><code><a href="../reference/select.html">select(df, c(a, b, c))</a></code> selects columns <code>a</code>, <code>b</code>, and <code>c</code>.</p></li>
<li><p><code><a href="../reference/select.html">select(df, starts_with("a"))</a></code> selects all columns whose name starts with “a”; <code><a href="../reference/select.html">select(df, ends_with("z"))</a></code> selects all columns whose name ends with “z”.</p></li>
<li><p><code><a href="../reference/select.html">select(df, is.numeric)</a></code> selects all numeric columns.</p></li>
</ul>
<p>You can see more details in <code><a href="../reference/dplyr_tidy_select.html">?dplyr_tidy_select</a></code>.</p>
</div>
<div id="indirection-1" class="section level3">
<h3 class="hasAnchor">
<a href="#indirection-1" class="anchor"></a>Indirection</h3>
<p>As with data masking, tidy selection makes a common task easier at the cost of making a less common task harder. When you want to use tidy select indirectly with the column specification stored in an intermediate variable, you’ll need to learn some new tools. Again, there are two forms of indirection:</p>
<ul>
<li>
<p>When you have the data-variable in an env-variable that is a function argument, you use the same technique as data masking: you <strong>embrace</strong> the argument by surrounding it in doubled braces.</p>
<p>The following function summarises a data frame by computing the mean of all variables selected by the user:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">summarise_mean</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">vars</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="../reference/context.html">n</a></span>(), <span class="fu"><a href="../reference/across.html">across</a></span>({{ <span class="no">vars</span> }}, <span class="no">mean</span>))
}
<span class="no">mtcars</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">cyl</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise_mean</span>(<span class="no">is.numeric</span>)</pre></body></html></div>
</li>
<li>
<p>When you have an env-variable that is a character vector, you need to use <code><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">all_of()</a></code> or <code><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">any_of()</a></code> depending on whether you want the function to error if a variable is not found.</p>
<p>The following code uses <code><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">all_of()</a></code> to select all of the variables found in a character vector; then <code>!</code> plus <code><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">all_of()</a></code> to select all of the variables <em>not</em> found in a character vector:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">vars</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mpg"</span>, <span class="st">"vs"</span>)
<span class="no">mtcars</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/select.html">select</a></span>(<span class="fu"><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">all_of</a></span>(<span class="no">vars</span>))
<span class="no">mtcars</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/select.html">select</a></span>(!<span class="fu"><a href="https://tidyselect.r-lib.org/reference/select_helpers.html">all_of</a></span>(<span class="no">vars</span>))</pre></body></html></div>
</li>
</ul>
</div>
</div>
<div id="how-tos" class="section level2">
<h2 class="hasAnchor">
<a href="#how-tos" class="anchor"></a>How tos</h2>
<p>The following examples solve a grab bag of common problems. We show you the minimum amount of code so that you can get the basic idea; most real problems will require more code or combining multiple techniques.</p>
<div id="user-supplied-data" class="section level3">
<h3 class="hasAnchor">
<a href="#user-supplied-data" class="anchor"></a>User-supplied data</h3>
<p>If you check the documentation, you’ll see that <code>.data</code> never uses data masking or tidy select. That means you don’t need to do anything special in your function:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">mutate_y</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>) {
  <span class="fu"><a href="../reference/mutate.html">mutate</a></span>(<span class="no">data</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">a</span> + <span class="no">x</span>)
}</pre></body></html></div>
</div>
<div id="eliminating-r-cmd-check-notes" class="section level3">
<h3 class="hasAnchor">
<a href="#eliminating-r-cmd-check-notes" class="anchor"></a>Eliminating <code>R CMD check</code> <code>NOTE</code>s</h3>
<p>If you’re writing a package and you have a function that uses data-variables:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">my_summary_function</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/filter.html">filter</a></span>(<span class="no">x</span> <span class="kw">&gt;</span> <span class="fl">0</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">grp</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">y</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="../reference/context.html">n</a></span>())
}</pre></body></html></div>
<p>You’ll get an <code>R CMD CHECK</code> <code>NOTE</code>:</p>
<pre><code>N  checking R code for possible problems
   my_summary_function: no visible binding for global variable ‘x’, ‘grp’, ‘y’
   Undefined global functions or variables:
     x grp y</code></pre>
<p>You can eliminate this by using <code>.data$var</code> and importing <code>.data</code> from its source in the <a href="https://rlang.r-lib.org/">rlang</a> package (the underlying package that implements tidy evaluation):</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="co">#' @importFrom rlang .data</span>
<span class="no">my_summary_function</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/filter.html">filter</a></span>(<span class="no">.data</span>$<span class="no">x</span> <span class="kw">&gt;</span> <span class="fl">0</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">.data</span>$<span class="no">grp</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">.data</span>$<span class="no">y</span>), <span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="../reference/context.html">n</a></span>())
}</pre></body></html></div>
</div>
<div id="one-or-more-user-supplied-expressions" class="section level3">
<h3 class="hasAnchor">
<a href="#one-or-more-user-supplied-expressions" class="anchor"></a>One or more user-supplied expressions</h3>
<p>If you want the user to supply an expression that’s passed onto an argument which uses data masking or tidy select, embrace the argument:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">my_summarise</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">group_var</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/group_by.html">group_by</a></span>({{ <span class="no">group_var</span> }}) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">mass</span>))
}</pre></body></html></div>
<p>This generalises in a straightforward way if you want to use one user-supplied expression in multiple places:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">my_summarise2</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">expr</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(
    <span class="kw">mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>({{ <span class="no">expr</span> }}),
    <span class="kw">sum</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>({{ <span class="no">expr</span> }}),
    <span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="../reference/context.html">n</a></span>()
  )
}</pre></body></html></div>
<p>If you want the user to provide multiple expressions, embrace each of them:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">my_summarise3</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">mean_var</span>, <span class="no">sd_var</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>({{ <span class="no">mean_var</span> }}), <span class="kw">sd</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>({{ <span class="no">sd_var</span> }}))
}</pre></body></html></div>
<p>If you want to use the names of variables in the output, you can use glue syntax in conjunction with <code>:=</code>:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">my_summarise4</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">expr</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(
    <span class="st">"mean_{{expr}}"</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>({{ <span class="no">expr</span> }}),
    <span class="st">"sum_{{expr}}"</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>({{ <span class="no">expr</span> }}),
    <span class="st">"n_{{expr}}"</span> <span class="kw">:=</span> <span class="fu"><a href="../reference/context.html">n</a></span>()
  )
}
<span class="no">my_summarise5</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">mean_var</span>, <span class="no">sd_var</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(
      <span class="st">"mean_{{mean_var}}"</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>({{ <span class="no">mean_var</span> }}),
      <span class="st">"sd_{{sd_var}}"</span> <span class="kw">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>({{ <span class="no">sd_var</span> }})
    )
}</pre></body></html></div>
</div>
<div id="any-number-of-user-supplied-expressions" class="section level3">
<h3 class="hasAnchor">
<a href="#any-number-of-user-supplied-expressions" class="anchor"></a>Any number of user-supplied expressions</h3>
<p>If you want to take an arbitrary number of user supplied expressions, use <code>...</code>. This is most often useful when you want to give the user full control over a single part of the pipeline, like a <code><a href="../reference/group_by.html">group_by()</a></code> or a <code><a href="../reference/mutate.html">mutate()</a></code>.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">my_summarise</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">.data</span>, <span class="no">...</span>) {
  <span class="no">.data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">...</span>) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="kw">mass</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">mass</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>), <span class="kw">height</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">height</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>))
}

<span class="no">starwars</span> <span class="kw">%&gt;%</span> <span class="fu">my_summarise</span>(<span class="no">homeworld</span>)
<span class="co">#&gt; # A tibble: 49 x 3</span>
<span class="co">#&gt;   homeworld    mass height</span>
<span class="co">#&gt; * &lt;chr&gt;       &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Alderaan       64   176.</span>
<span class="co">#&gt; 2 Aleen Minor    15    79 </span>
<span class="co">#&gt; 3 Bespin         79   175 </span>
<span class="co">#&gt; 4 Bestine IV    110   180 </span>
<span class="co">#&gt; # … with 45 more rows</span>
<span class="no">starwars</span> <span class="kw">%&gt;%</span> <span class="fu">my_summarise</span>(<span class="no">sex</span>, <span class="no">gender</span>)
<span class="co">#&gt; # A tibble: 6 x 4</span>
<span class="co">#&gt; # Groups:   sex [5]</span>
<span class="co">#&gt;   sex            gender      mass height</span>
<span class="co">#&gt;   &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 female         feminine    54.7   169.</span>
<span class="co">#&gt; 2 hermaphroditic masculine 1358     175 </span>
<span class="co">#&gt; 3 male           masculine   81.0   179.</span>
<span class="co">#&gt; 4 none           feminine   NaN      96 </span>
<span class="co">#&gt; # … with 2 more rows</span></pre></body></html></div>
<p>When you use <code>...</code> in this way, make sure that any other arguments start with <code>.</code> to reduce the chances of argument clashes; see <a href="https://design.tidyverse.org/dots-prefix.html" class="uri">https://design.tidyverse.org/dots-prefix.html</a> for more details.</p>
</div>
<div id="transforming-user-supplied-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#transforming-user-supplied-variables" class="anchor"></a>Transforming user-supplied variables</h3>
<p>If you want the user to provide a set of data-variables that are then transformed, use <code><a href="../reference/across.html">across()</a></code>:</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">my_summarise</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">summary_vars</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="fu"><a href="../reference/across.html">across</a></span>({{ <span class="no">summary_vars</span> }}, ~ <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">.</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)))
}
<span class="no">starwars</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="no">species</span>) <span class="kw">%&gt;%</span>
  <span class="fu">my_summarise</span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">mass</span>, <span class="no">height</span>))
<span class="co">#&gt; # A tibble: 38 x 3</span>
<span class="co">#&gt;   species   mass height</span>
<span class="co">#&gt; * &lt;chr&gt;    &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 Aleena      15     79</span>
<span class="co">#&gt; 2 Besalisk   102    198</span>
<span class="co">#&gt; 3 Cerean      82    198</span>
<span class="co">#&gt; 4 Chagrian   NaN    196</span>
<span class="co">#&gt; # … with 34 more rows</span></pre></body></html></div>
<p>You can use this same idea for multiple sets of input data-variables:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="no">my_summarise</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">group_var</span>, <span class="no">summarise_var</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="fu"><a href="../reference/across.html">across</a></span>({{ <span class="no">group_var</span> }})) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="fu"><a href="../reference/across.html">across</a></span>({{ <span class="no">group_var</span> }}, <span class="no">mean</span>))
}</pre></body></html></div>
<p>Use the <code>.names</code> argument to <code><a href="../reference/across.html">across()</a></code> to control the names of the output.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">my_summarise</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">data</span>, <span class="no">group_var</span>, <span class="no">summarise_var</span>) {
  <span class="no">data</span> <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/group_by.html">group_by</a></span>(<span class="fu"><a href="../reference/across.html">across</a></span>({{ <span class="no">group_var</span> }})) <span class="kw">%&gt;%</span>
    <span class="fu"><a href="../reference/summarise.html">summarise</a></span>(<span class="fu"><a href="../reference/across.html">across</a></span>({{ <span class="no">summarise_var</span> }}, <span class="no">mean</span>, <span class="kw">.names</span> <span class="kw">=</span> <span class="st">"mean_{col}"</span>))
}</pre></body></html></div>
</div>
<div id="loop-over-multiple-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#loop-over-multiple-variables" class="anchor"></a>Loop over multiple variables</h3>
<p>If you have a character vector of variable names, and want to operate on them with a for loop, index into the special <code>.data</code> pronoun:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="kw">for</span> (<span class="no">var</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mtcars</span>)) {
  <span class="no">mtcars</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="../reference/count.html">count</a></span>(<span class="no">.data</span><span class="kw">[[</span><span class="no">var</span>]]) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>()
}</pre></body></html></div>
<p>This same technique works with for loop alternatives like the base R <code><a href="https://rdrr.io/r/base/apply.html">apply()</a></code> family and the purrr <code>map()</code> family:</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">mtcars</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">purrr</span><span class="kw ns">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(~ <span class="fu"><a href="../reference/count.html">count</a></span>(<span class="no">mtcars</span>, <span class="no">.data</span><span class="kw">[[</span><span class="no">.x</span>]]))</pre></body></html></div>
</div>
<div id="use-a-variable-from-an-shiny-input" class="section level3">
<h3 class="hasAnchor">
<a href="#use-a-variable-from-an-shiny-input" class="anchor"></a>Use a variable from an Shiny input</h3>
<p>Many Shiny input controls return character vectors, so you can use the same approach as above: <code>.data[[input$var]]</code>.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">shiny</span>)
<span class="no">ui</span> <span class="kw">&lt;-</span> <span class="fu">fluidPage</span>(
  <span class="fu">selectInput</span>(<span class="st">"var"</span>, <span class="st">"Variable"</span>, <span class="kw">choices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">diamonds</span>)),
  <span class="fu">tableOutput</span>(<span class="st">"output"</span>)
)
<span class="no">server</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>) {
  <span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu">reactive</span>(<span class="fu"><a href="../reference/filter.html">filter</a></span>(<span class="no">diamonds</span>, <span class="no">.data</span><span class="kw">[[</span><span class="no">input</span>$<span class="no">var</span>]] <span class="kw">&gt;</span> <span class="fl">0</span>))
  <span class="no">output</span>$<span class="no">output</span> <span class="kw">&lt;-</span> <span class="fu">renderTable</span>(<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>()))
}</pre></body></html></div>
<p>See <a href="https://mastering-shiny.org/action-tidy.html" class="uri">https://mastering-shiny.org/action-tidy.html</a> for more details and case studies.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>dplyr’s <code><a href="../reference/filter.html">filter()</a></code> is inspired by base R’s <code><a href="https://rdrr.io/r/base/subset.html">subset()</a></code>. <code><a href="https://rdrr.io/r/base/subset.html">subset()</a></code> provides data masking, but not with tidy evaluation, so the techniques described in this chapter don’t apply to it.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>In R, arguments are lazily evaluated which means that until you attempt to use, they don’t hold a value, just a <strong>promise</strong> that describes how to compute the value. You can learn more at <a href="https://adv-r.hadley.nz/functions.html#lazy-evaluation" class="uri">https://adv-r.hadley.nz/functions.html#lazy-evaluation</a><a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="tidyverse">
  <p>dplyr is a part of the <strong>tidyverse</strong>, an ecosystem of packages designed with common APIs and a shared philosophy. Learn more at <a href="https://tidyverse.org">tidyverse.org</a>.</p>
</div>

<div class="author">
  <p>
    Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Romain François, Lionel Henry, <a href="http://krlmlr.info">Kirill Müller</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.
    Site built by <a href="https://pkgdown.r-lib.org">pkgdown</a>.
  </p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '1270c4079b26a138795263974bbf302d',
    indexName: 'tidyverse',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
