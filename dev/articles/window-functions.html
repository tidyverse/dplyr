<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Window functions • dplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Window functions">
<meta name="description" content="Window functions are a useful family of functions that work with vectors (returning an output the same size as the input), and combine naturally with `mutate()` and `filter()`.
">
<meta property="og:description" content="Window functions are a useful family of functions that work with vectors (returning an output the same size as the input), and combine naturally with `mutate()` and `filter()`.
">
<meta property="og:image" content="https://dplyr.tidyverse.org/logo.png">
<meta name="robots" content="noindex">
<script defer data-domain="dplyr.tidyverse.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dplyr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.4.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/dplyr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/grouping.html">Grouped data</a></li>
    <li><a class="dropdown-item" href="../articles/two-table.html">Two-table verbs</a></li>
    <li><a class="dropdown-item" href="../articles/base.html">dplyr &lt;-&gt; base R</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Automation</h6></li>
    <li><a class="dropdown-item" href="../articles/colwise.html">Column-wise operations</a></li>
    <li><a class="dropdown-item" href="../articles/rowwise.html">Row-wise operations</a></li>
    <li><a class="dropdown-item" href="../articles/programming.html">Programming with dplyr</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news">
<li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/tags/dplyr-1-1-0/">Version 1.1.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/06/dplyr-1-0-0/">Version 1.0.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/07/dplyr-0-8-3/">Version 0.8.3</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/06/dplyr-0-8-2/">Version 0.8.2</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/05/dplyr-0-8-1/">Version 0.8.1</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/02/dplyr-0-8-0/">Version 0.8.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/06/dplyr-0.7.5/">Version 0.7.5</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/tidyverse/dplyr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Window functions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dplyr/blob/main/vignettes/window-functions.Rmd" class="external-link"><code>vignettes/window-functions.Rmd</code></a></small>
      <div class="d-none name"><code>window-functions.Rmd</code></div>
    </div>

    
    
<p>A <strong>window function</strong> is a variation on an aggregation
function. Where an aggregation function, like <code><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum()</a></code> and
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>, takes n inputs and return a single value, a window
function returns n values. The output of a window function depends on
all its input values, so window functions don’t include functions that
work element-wise, like <code>+</code> or <code><a href="https://rdrr.io/r/base/Round.html" class="external-link">round()</a></code>. Window
functions include variations on aggregate functions, like
<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum()</a></code> and <code><a href="../reference/cumall.html">cummean()</a></code>, functions for ranking
and ordering, like <code><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank()</a></code>, and functions for taking
offsets, like <code><a href="../reference/lead-lag.html">lead()</a></code> and <code><a href="../reference/lead-lag.html">lag()</a></code>.</p>
<p>In this vignette, we’ll use a small sample of the Lahman batting
dataset, including the players that have won an award.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://CRAN.R-project.org/package=Lahman" class="external-link">Lahman</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">batting</span> <span class="op">&lt;-</span> <span class="fu">Lahman</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Lahman/man/Batting.html" class="external-link">Batting</a></span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/select.html">select</a></span><span class="op">(</span><span class="va">playerID</span>, <span class="va">yearID</span>, <span class="va">teamID</span>, <span class="va">G</span>, <span class="va">AB</span><span class="op">:</span><span class="va">H</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">playerID</span>, <span class="va">yearID</span>, <span class="va">teamID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="fu">Lahman</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Lahman/man/AwardsPlayers.html" class="external-link">AwardsPlayers</a></span>, by <span class="op">=</span> <span class="st">"playerID"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">players</span> <span class="op">&lt;-</span> <span class="va">batting</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">playerID</span><span class="op">)</span></span></code></pre></div>
<p>Window functions are used in conjunction with <code><a href="../reference/mutate.html">mutate()</a></code>
and <code><a href="../reference/filter.html">filter()</a></code> to solve a wide range of problems. Here’s a
selection:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For each player, find the two years with most hits</span></span>
<span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="fu"><a href="../reference/row_number.html">min_rank</a></span><span class="op">(</span><span class="fu"><a href="../reference/desc.html">desc</a></span><span class="op">(</span><span class="va">H</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="op">&amp;</span> <span class="va">H</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co"># Within each player, rank each year by the number of games played</span></span>
<span><span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>, G_rank <span class="op">=</span> <span class="fu"><a href="../reference/row_number.html">min_rank</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For each player, find every year that was better than the previous year</span></span>
<span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="va">G</span> <span class="op">&gt;</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># For each player, compute avg change in games played per year</span></span>
<span><span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>, G_change <span class="op">=</span> <span class="op">(</span><span class="va">G</span> <span class="op">-</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">yearID</span> <span class="op">-</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">yearID</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># For each player, find all years where they played more games than they did on average</span></span>
<span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="va">G</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># For each, player compute a z score based on number of games played</span></span>
<span><span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>, G_z <span class="op">=</span> <span class="op">(</span><span class="va">G</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Before reading this vignette, you should be familiar with
<code><a href="../reference/mutate.html">mutate()</a></code> and <code><a href="../reference/filter.html">filter()</a></code>.</p>
<div class="section level2">
<h2 id="types-of-window-functions">Types of window functions<a class="anchor" aria-label="anchor" href="#types-of-window-functions"></a>
</h2>
<p>There are five main families of window functions. Two families are
unrelated to aggregation functions:</p>
<ul>
<li><p>Ranking and ordering functions: <code><a href="../reference/row_number.html">row_number()</a></code>,
<code><a href="../reference/row_number.html">min_rank()</a></code>, <code><a href="../reference/row_number.html">dense_rank()</a></code>,
<code><a href="../reference/percent_rank.html">cume_dist()</a></code>, <code><a href="../reference/percent_rank.html">percent_rank()</a></code>, and
<code><a href="../reference/ntile.html">ntile()</a></code>. These functions all take a vector to order by, and
return various types of ranks.</p></li>
<li><p>Offsets <code><a href="../reference/lead-lag.html">lead()</a></code> and <code><a href="../reference/lead-lag.html">lag()</a></code> allow you to
access the previous and next values in a vector, making it easy to
compute differences and trends.</p></li>
</ul>
<p>The other three families are variations on familiar aggregate
functions:</p>
<ul>
<li><p>Cumulative aggregates: <code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum()</a></code>,
<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummin()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummax()</a></code> (from base R), and
<code><a href="../reference/cumall.html">cumall()</a></code>, <code><a href="../reference/cumall.html">cumany()</a></code>, and <code><a href="../reference/cumall.html">cummean()</a></code>
(from dplyr).</p></li>
<li><p>Rolling aggregates operate in a fixed width window. You won’t
find them in base R or in dplyr, but there are many implementations in
other packages, such as <a href="https://cran.r-project.org/package=RcppRoll" class="external-link">RcppRoll</a>.</p></li>
<li><p>Recycled aggregates, where an aggregate is repeated to match the
length of the input. These are not needed in R because vector recycling
automatically recycles aggregates where needed. They are important in
SQL, because the presence of an aggregation function usually tells the
database to return only one row per group.</p></li>
</ul>
<p>Each family is described in more detail below, focussing on the
general goals and how to use them with dplyr. For more details, refer to
the individual function documentation.</p>
</div>
<div class="section level2">
<h2 id="ranking-functions">Ranking functions<a class="anchor" aria-label="anchor" href="#ranking-functions"></a>
</h2>
<p>The ranking functions are variations on a theme, differing in how
they handle ties:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/row_number.html">row_number</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 2 3 4 5</span></span>
<span><span class="fu"><a href="../reference/row_number.html">min_rank</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 1 3 3 3</span></span>
<span><span class="fu"><a href="../reference/row_number.html">dense_rank</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1 1 2 2 2</span></span></code></pre></div>
<p>If you’re familiar with R, you may recognise that
<code><a href="../reference/row_number.html">row_number()</a></code> and <code><a href="../reference/row_number.html">min_rank()</a></code> can be computed
with the base <code><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank()</a></code> function and various values of the
<code>ties.method</code> argument. These functions are provided to save
a little typing, and to make it easier to convert between R and SQL.</p>
<p>Two other ranking functions return numbers between 0 and 1.
<code><a href="../reference/percent_rank.html">percent_rank()</a></code> gives the percentage of the rank;
<code><a href="../reference/percent_rank.html">cume_dist()</a></code> gives the proportion of values less than or
equal to the current value.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/percent_rank.html">cume_dist</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.4 0.4 1.0 1.0 1.0</span></span>
<span><span class="fu"><a href="../reference/percent_rank.html">percent_rank</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.0 0.0 0.5 0.5 0.5</span></span></code></pre></div>
<p>These are useful if you want to select (for example) the top 10% of
records within each group. For example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="fu"><a href="../reference/percent_rank.html">cume_dist</a></span><span class="op">(</span><span class="fu"><a href="../reference/desc.html">desc</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,110 × 7</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   playerID [1,014]</span></span></span>
<span><span class="co">#&gt;   playerID  yearID teamID     G    AB     R     H</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> aaronha01   <span style="text-decoration: underline;">1</span>963 ML1      161   631   121   201</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> aaronha01   <span style="text-decoration: underline;">1</span>968 ATL      160   606    84   174</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> abbotji01   <span style="text-decoration: underline;">1</span>991 CAL       34     0     0     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> abernte02   <span style="text-decoration: underline;">1</span>965 CHN       84    18     1     3</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,106 more rows</span></span></span></code></pre></div>
<p>Finally, <code><a href="../reference/ntile.html">ntile()</a></code> divides the data up into <code>n</code>
evenly sized buckets. It’s a coarse ranking, and it can be used in with
<code><a href="../reference/mutate.html">mutate()</a></code> to divide the data into buckets for further
summary. For example, we could use <code><a href="../reference/ntile.html">ntile()</a></code> to divide the
players within a team into four ranked groups, and calculate the average
number of games within each group.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_team_player</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">batting</span>, <span class="va">teamID</span>, <span class="va">playerID</span><span class="op">)</span></span>
<span><span class="va">by_team</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">by_team_player</span>, G <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'teamID'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="va">by_team_quartile</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">by_team</span>, quartile <span class="op">=</span> <span class="fu"><a href="../reference/ntile.html">ntile</a></span><span class="op">(</span><span class="va">G</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">by_team_quartile</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 2</span></span></span>
<span><span class="co">#&gt;   quartile `mean(G)`</span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>        1      22.9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>        2      92.0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>        3     251. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>        4     952.</span></span></code></pre></div>
<p>All ranking functions rank from lowest to highest so that small input
values get small ranks. Use <code><a href="../reference/desc.html">desc()</a></code> to rank from highest to
lowest.</p>
</div>
<div class="section level2">
<h2 id="lead-and-lag">Lead and lag<a class="anchor" aria-label="anchor" href="#lead-and-lag"></a>
</h2>
<p><code><a href="../reference/lead-lag.html">lead()</a></code> and <code><a href="../reference/lead-lag.html">lag()</a></code> produce offset versions of
a input vector that is either ahead of or behind the original
vector.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="fu"><a href="../reference/lead-lag.html">lead</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  2  3  4  5 NA</span></span>
<span><span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] NA  1  2  3  4</span></span></code></pre></div>
<p>You can use them to:</p>
<ul>
<li>
<p>Compute differences or percent changes.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compute the relative change in games played</span></span>
<span><span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>, G_delta <span class="op">=</span> <span class="va">G</span> <span class="op">-</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Using <code><a href="../reference/lead-lag.html">lag()</a></code> is more convenient than <code><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff()</a></code>
because for <code>n</code> inputs <code><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff()</a></code> returns
<code>n - 1</code> outputs.</p>
</li>
<li>
<p>Find out when a value changes.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find when a player changed teams</span></span>
<span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="va">teamID</span> <span class="op">!=</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">teamID</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
</ul>
<p><code><a href="../reference/lead-lag.html">lead()</a></code> and <code><a href="../reference/lead-lag.html">lag()</a></code> have an optional argument
<code>order_by</code>. If set, instead of using the row order to
determine which value comes before another, they will use another
variable. This is important if you have not already sorted the data, or
you want to sort one way and lag another.</p>
<p>Here’s a simple example of what happens if you don’t specify
<code>order_by</code> when you need it:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2005</span>, value <span class="op">=</span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">scrambled</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">wrong</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">scrambled</span>, prev_value <span class="op">=</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">wrong</span>, <span class="va">year</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year value prev_value</span></span>
<span><span class="co">#&gt; 1 2000     0          4</span></span>
<span><span class="co">#&gt; 2 2001     1          0</span></span>
<span><span class="co">#&gt; 3 2002     4          9</span></span>
<span><span class="co">#&gt; 4 2003     9         16</span></span>
<span><span class="co">#&gt; 5 2004    16         NA</span></span>
<span><span class="co">#&gt; 6 2005    25          1</span></span>
<span></span>
<span><span class="va">right</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">scrambled</span>, prev_value <span class="op">=</span> <span class="fu"><a href="../reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">value</span>, order_by <span class="op">=</span> <span class="va">year</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">right</span>, <span class="va">year</span><span class="op">)</span></span>
<span><span class="co">#&gt;   year value prev_value</span></span>
<span><span class="co">#&gt; 1 2000     0         NA</span></span>
<span><span class="co">#&gt; 2 2001     1          0</span></span>
<span><span class="co">#&gt; 3 2002     4          1</span></span>
<span><span class="co">#&gt; 4 2003     9          4</span></span>
<span><span class="co">#&gt; 5 2004    16          9</span></span>
<span><span class="co">#&gt; 6 2005    25         16</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cumulative-aggregates">Cumulative aggregates<a class="anchor" aria-label="anchor" href="#cumulative-aggregates"></a>
</h2>
<p>Base R provides cumulative sum (<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum()</a></code>), cumulative
min (<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummin()</a></code>), and cumulative max (<code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cummax()</a></code>).
(It also provides <code><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumprod()</a></code> but that is rarely useful).
Other common accumulating functions are <code><a href="../reference/cumall.html">cumany()</a></code> and
<code><a href="../reference/cumall.html">cumall()</a></code>, cumulative versions of <code>||</code> and
<code>&amp;&amp;</code>, and <code><a href="../reference/cumall.html">cummean()</a></code>, a cumulative mean.
These are not included in base R, but efficient versions are provided by
<code>dplyr</code>.</p>
<p><code><a href="../reference/cumall.html">cumany()</a></code> and <code><a href="../reference/cumall.html">cumall()</a></code> are useful for
selecting all rows up to, or all rows after, a condition is true for the
first (or last) time. For example, we can use <code><a href="../reference/cumall.html">cumany()</a></code> to
find all records for a player after they played a year with 150
games:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="fu"><a href="../reference/cumall.html">cumany</a></span><span class="op">(</span><span class="va">G</span> <span class="op">&gt;</span> <span class="fl">150</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Like lead and lag, you may want to control the order in which the
accumulation occurs. None of the built in functions have an
<code>order_by</code> argument so <code>dplyr</code> provides a helper:
<code><a href="../reference/order_by.html">order_by()</a></code>. You give it the variable you want to order by,
and then the call to the window function:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fl">10</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="fu"><a href="../reference/order_by.html">order_by</a></span><span class="op">(</span><span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 55 54 52 49 45 40 34 27 19 10</span></span></code></pre></div>
<p>This function uses a bit of non-standard evaluation, so I wouldn’t
recommend using it inside another function; use the simpler but less
concise <code><a href="../reference/with_order.html">with_order()</a></code> instead.</p>
</div>
<div class="section level2">
<h2 id="recycled-aggregates">Recycled aggregates<a class="anchor" aria-label="anchor" href="#recycled-aggregates"></a>
</h2>
<p>R’s vector recycling makes it easy to select values that are higher
or lower than a summary. I call this a recycled aggregate because the
value of the aggregate is recycled to be the same length as the original
vector. Recycled aggregates are useful if you want to find all records
greater than the mean or less than the median:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="va">G</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="va">G</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>While most SQL databases don’t have an equivalent of
<code><a href="https://rdrr.io/r/stats/median.html" class="external-link">median()</a></code> or <code><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile()</a></code>, when filtering you can
achieve the same effect with <code><a href="../reference/ntile.html">ntile()</a></code>. For example,
<code>x &gt; median(x)</code> is equivalent to
<code>ntile(x, 2) == 2</code>; <code>x &gt; quantile(x, 75)</code> is
equivalent to <code>ntile(x, 100) &gt; 75</code> or
<code>ntile(x, 4) &gt; 3</code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/filter.html">filter</a></span><span class="op">(</span><span class="va">players</span>, <span class="fu"><a href="../reference/ntile.html">ntile</a></span><span class="op">(</span><span class="va">G</span>, <span class="fl">2</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>You can also use this idea to select the records with the highest
(<code>x == max(x)</code>) or lowest value (<code>x == min(x)</code>)
for a field, but the ranking functions give you more control over ties,
and allow you to select any number of records.</p>
<p>Recycled aggregates are also useful in conjunction with
<code><a href="../reference/mutate.html">mutate()</a></code>. For example, with the batting data, we could
compute the “career year”, the number of years a player has played since
they entered the league:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>, career_year <span class="op">=</span> <span class="va">yearID</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">yearID</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 21,314 × 8</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   playerID [1,485]</span></span></span>
<span><span class="co">#&gt;   playerID  yearID teamID     G    AB     R     H career_year</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> aaronha01   <span style="text-decoration: underline;">1</span>954 ML1      122   468    58   131           1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> aaronha01   <span style="text-decoration: underline;">1</span>955 ML1      153   602   105   189           2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> aaronha01   <span style="text-decoration: underline;">1</span>956 ML1      153   609   106   200           3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> aaronha01   <span style="text-decoration: underline;">1</span>957 ML1      151   615   118   198           4</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 21,310 more rows</span></span></span></code></pre></div>
<p>Or, as in the introductory example, we could compute a z-score:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">players</span>, G_z <span class="op">=</span> <span class="op">(</span><span class="va">G</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">G</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 21,314 × 8</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   playerID [1,485]</span></span></span>
<span><span class="co">#&gt;   playerID  yearID teamID     G    AB     R     H    G_z</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> aaronha01   <span style="text-decoration: underline;">1</span>954 ML1      122   468    58   131 -<span style="color: #BB0000;">1.16</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> aaronha01   <span style="text-decoration: underline;">1</span>955 ML1      153   602   105   189  0.519</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> aaronha01   <span style="text-decoration: underline;">1</span>956 ML1      153   609   106   200  0.519</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> aaronha01   <span style="text-decoration: underline;">1</span>957 ML1      151   615   118   198  0.411</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 21,310 more rows</span></span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://github.com/romainfrancois" class="external-link">Romain François</a>, <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://krlmlr.info" class="external-link">Kirill Müller</a>, <a href="https://github.com/DavisVaughan" class="external-link">Davis Vaughan</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
